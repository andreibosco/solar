<%= javascript_include_tag "group_assignments" %>

<div>
  <!-- Descricao da atividade -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2>
        <%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %><%= @assignment.name %>
      </h2>
    </div>
    <div id="individual_activity_description" class="block_content">
      <!-- Descricao da atividade -->
      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%">
        <thead>
          <tr class="lines">
            <th><%=t(:activity_description)%></th>
            <th align="right" style="width:70px">
              <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
              <span>
                Início
              </span>
            </th>
            <th align="right" style="width:70px">
              <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
              <span>
                Fim
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="lines" >
            <td>
              <%= @assignment.enunciation %>
            </td>
            <td class="center">
              <%= l(@assignment.schedule.start_date, :format => :files) %>
            </td>
            <td class="center">
              <%= l(@assignment.schedule.end_date, :format => :files) %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Participantes do grupo -->
  <% if @assignment.type_assignment == Group_Activity %>
    <div id="activities" class="block_wrapper">
      <div class="block_title">
        <h2>
          <%= image_tag "icon_participants.png", :alt => " ", :class=>'block_title_icon' %><%#= @group.group_name %>
        </h2>
      </div>
      <div id="individual_activity_description" class="block_content">
        <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%">
          <thead>
            <tr class="lines">
              <th>Participantes</th>
            </tr>
          </thead>
          <tbody>
            <% gp = group_participants(@group_id)
            gp.each{ |participant| %>
              <tr class="lines" >
                <td>
                  <%= participant['name'] %>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Arquivos enviados pelo aluno -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2>
        <%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %>Arquivos enviados
      </h2>
      <span class="download_all_icon">
        <% unless @files_sent_assignment.empty? %>
          <%= image_tag "mimetypes/zip.png", :alt => " ", :class=>'block_title_icon' %>
          <%= link_to t(:portfolio_download_all_zip), {:controller => :group_assignments, :action => :download_all_files_zip, :all_files => @files_student_assignment, :assignment_id => @assignment.id}, :class => "link_content" %>
        <% end %>
      </span>
    </div>
    <div id="files_assignment_student" class="block_content">
      <% unless @files_sent_assignment.empty? %>
        <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%">
          <thead>
            <tr class="lines">
              <th>Nome</th>
              <th align="right" style="width: 80px">Tamanho</th>
              <% if @assignment.type_assignment == Group_Activity %>
                <th align="right" style="width: 80px">Enviado por</th>
              <% end %>
              <th align="center" style="width:80px">
                <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
                <span>
                  Enviado em
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% @files_sent_assignment.each{ |file|  %>
              <tr class="lines" >
                <td>
                  <%= link_to image_tag(icon_attachment(file.attachment_file_name)), {:controller=>:group_assignments, :action=>:download_single_file, :file_id => file.id, :assignment_id => @assignment.id }, {:class => "file_icon", :alt => t(:file_type_icon)} %>
                  <%= link_to file.attachment_file_name, {:controller => :group_assignments, :action => :download_single_file, :file_id => file.id, :assignment_id => @assignment.id }, :class => "link_content" %>
                </td>
                <td class="right">
                  <%= format('%.2f KB', file.attachment_file_size/1024.0) %>
                </td>
                <% if @assignment.type_assignment == Group_Activity %>
                  <td class="right">
                    <%= file.user.nick %>
                  </td>
                <% end %>
                <td class="center">
                  <%= l(file.attachment_updated_at, :format => :file) %>
                </td>
              </tr>
            <% } %>      
          </tbody>
        </table>
      <% else %>
        <div class="portfolio_div_padding">
          <%= t(:itens_not_found) %>
        </div>
      <% end %>
    </div>
  </div>

   <!-- Área de avaliação -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2><%= image_tag "icon_participants.png", :alt => " ", :class=>'block_title_icon' %>Avaliação</h2>
      <span class="portfolio_title_button">
        <input id="btn_evaluate" type="button" value='<%=t(:portfolio_evaluate)%>' class="btn btn_main" onclick="btn_evaluate();"/>
        <input id="btn_cancel_evaluation" type="button" value='<%=t(:portfolio_cancel)%>' class="btn btn_caution" style="display:none" onclick="btn_cancel_evaluation();"/>
        <input id="btn_save_evaluation" type="button" value='<%=t(:portfolio_save)%>' class="btn btn_main" style="display:none" onclick="btn_save_evaluation('<%=@assignment.id%>', '<%=@student_id%>' ,'<%=@group_id%>');"/>
      </span>
    </div>
    <div id="evaluate_assignment_student" class="block_content">
      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%" id="tb_student_assignment">
        <% unless @send_assignment.nil? or (@send_assignment.grade.nil? and @send_assignment.comment.nil?) %>
          <thead>
            <tr class="lines">
              <th align="right" style="width:30px"><%= t(:grade) %></th>
              <th><%= t(:comment) %></th>
            </tr>
          </thead>
          <tbody>
              <tr class="lines" >
                <td><%= @send_assignment.grade %></td>
                <td><%= @send_assignment.comment %></td>
              </tr>
          </tbody>
        <% else %>
          <div class="portfolio_div_padding" id="no_itens_evaluation_tb">
            <%= t(:itens_not_found) %>
          </div>
        <% end %>
      </table>

      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%" id="tb_student_assignment_evaluate" style="display: none">
        <thead>
          <tr class="lines">
            <th align="right" style="width:30px"><%= t(:grade) %></th>
            <th><%= t(:comment) %></th>
          </tr>
        </thead>
        <tbody>
            <tr class="lines" >
              <td><%= text_field_tag :evaluation_grade, @send_assignment.nil? ? "" : @send_assignment.grade, :size => 3 %></td>
              <td><%= text_area_tag :evaluation_comment, @send_assignment.nil? ? "" : @send_assignment.comment, :rows => 4, :cols => 113 %></td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Área de comentários -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2><%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %>Comentários</h2>
      <span class="portfolio_title_button">
        <input id="btn_comment" type="button" value='<%=t(:portfolio_comment)%>' class="btn btn_main" onclick="btn_comment();"/>
      </span>
    </div>

    <div id="comment_assignment_student" class="forum_posts_wrapper">
      <div class="comment_form" style="display:none">
         <%= form_for(:assignment_comment, :html => {:id => 'comment_form', :multipart => true}, :url => {:controller => :portfolio_teacher, :action => :update_comment, :assignment_id => @assignment.id, :student_id => @student_id, :group_id => @group_id}) do |f| %>
            <table class="forum_post" border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
              <td rowspan="3" class="forum_post_icon">
                <%= image_tag('no_image_forum.png') %>
              </td>
              <td class="forum_post_head">
                <div class="forum_post_author">
                  <div class="forum_participant_nick" alt="fulano">
                    <%= @user.nick %>
                  </div>
                  <div class="forum_participant_profile" >
                    <%= @user_profile.name %>
                  </div>
                </div>
                <div class="forum_post_date">
                    <%=l Date.current %>
                </div>
              </td>
            </tr>
            <tr>
              <td class="forum_post_content" colspan="2">
                <div class="forum_post_inner_content">
                  <%= text_area_tag :comment, '', :rows => 4, :cols => 116 %>
                </div>
                <div class="forum_post_attachment">
                  <h3>
                    Anexos
                  </h3>
                  <ul class="forum_post_attachment_list comments_files_div">
                    <%= file_field_tag 'comment_files[]', :class => "comments_files" %>
                    <a href="#" class="more_comment_files_link" onclick="more_files();" >
                      <%= t(:forum_attach_another_file) %>
                    </a>
                  </ul>
                </div>
              </td>
            </tr>
            <tr></tr>
          </table>
          <div class="portfolio_title_button">
      <input id="btn_cancel_comment" type="button" value='<%=t(:portfolio_cancel)%>' class="btn btn_caution" onclick="btn_cancel_comment_();"/>
            <input id="btn_save_comment" type="button" value='<%=t(:portfolio_save)%>' class="btn btn_main"  onclick="btn_save_comment_('<%=@assignment.id%>', '<%=@student_id%>', '<%=@group_id%>');"/>
            <%#= submit_tag "Enviar", :class=>'btn btn_main' %>
          </div>
        <% end %>
      </div>
      <% unless @comments.empty? %>
        <% @comments.each_with_index{ |comment, idx| %>
          <table class="forum_post tb_comments" border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
              <td rowspan="3" class="forum_post_icon">
                <%= image_tag(comment.user.photo.url(:forum), :alt => t(:mysolar_alt_img_user) + ' ' + comment.user.nick) %>
              </td>
              <td class="forum_post_head">
                <div class="forum_post_author">
                  <div class="forum_participant_nick" alt="fulano">
                    <%= comment.user.nick %>
                  </div>
                  <div class="forum_participant_profile" >
                    <%= @users_profiles[idx].name %>
                  </div>
                </div>
                <div class="forum_post_date">
                  <% unless comment.updated_at.blank? %>
                    <%=l comment.updated_at %>
                  <% else %>
                    Sem data
                  <% end %>
                </div>
              </td>
            </tr>
            <tr>
              <td class="forum_post_content" colspan="2">
                <div class="forum_post_inner_content">
                  <%= comment.comment %>
                </div>
                <div class="forum_post_attachment">
                  <h3>
                    Anexos
                  </h3>
                  <ul class="forum_post_attachment_list">
                    <% @comments_files[idx].each{| comment_file | %>
                      <li>
                        <%= link_to comment_file.attachment_file_name, {:controller => :group_assignments, :action => :download_single_file,                                    :file_id => comment_file.id, :assignment_id => @assignment.id}, :class => "link_content" %>
                        <div class="forum_post_date">
                          <%=l comment_file.attachment_updated_at %>
                        </div>
                      </li>
                    <% } %>  
                  </ul>
                </div>
              </td>
            </tr>
            <tr></tr>
          </table>
        <% } %>
      <% else %>
        <div id="no_itens_message_comment" class="block_content portfolio_div_padding">
          <%= t(:itens_not_found) %>
        </div>
      <% end %>
    </div>
  </div>

<script type="text/javascript">

// Comentários

 function btn_comment(){
    $("#no_itens_message_comment").hide();
    $("#btn_comment").hide();
    $(".comment_form").fadeIn();
  }

  function undo_btn_comment_changes(){
    $("#btn_comment").fadeIn(); 
    $(".comment_form").hide();
    show_no_itens_div = $('td', '#tb_comments').length == 0;
    if(show_no_itens_div){
      $("#no_itens_message_comment").fadeIn();
    }
  }

  function more_files() {
    $(".more_comment_files_link").remove();
    $('<div><input id="comment_files_" class="comments_files" name="comment_files[]" type="file"><a href="#" class="more_comment_files_link" onclick="more_files();" ><%= t(:forum_attach_another_file) %></a></div>').appendTo($(".comments_files_div"));
  }

  function btn_cancel_comment_(){
    if (confirm('<%= t(:portfolio_cancel_comment) %>')){
      undo_btn_comment_changes();  
      flash_message('<%= t(:comment_canceled) %>', 'notice');
      var dont_have_comments = $('.tb_comments').length == 0;
      if(dont_have_comments){
        $('<div id="no_itens_message_comment" class="block_content portfolio_div_padding"><%= t(:itens_not_found) %></div>').appendTo($("#comment_assignment_student"));
      }
    }
  }

  function btn_save_comment_(assignment_id, student_id, group_id){
    if (confirm('<%= t(:portfolio_confirm_comment) %>')){
     
      $.ajax({
        url: $('#comment_form').submit(),
        type: 'POST',
        success: function(data) {
          if (data.success == false) {
            continue_with_request = false;
            flash_message(data.flash_msg, data.flash_class);
            if (data.cancel == true) {
              undo_btn_comment_changes();
              show_no_itens_div = $('td', '#tb_comments').length == 0;
              $('<div id="no_itens_message_comment" class="block_content portfolio_div_padding"><%= t(:itens_not_found) %></div>').appendTo($('#comment_assignment_student'));
            }
          }else{
            $("#comment_assignment_student").html(data);
            undo_btn_comment_changes();
            flash_message('<%= t(:comment_sent_success) %>', 'notice');
          }
        }
      });
      return continue_with_request; 
    }
  }

// Avaliação

  function btn_evaluate(){
    $("#tb_student_assignment").hide();
    $("#no_itens_evaluation_tb").hide();
    $("#tb_student_assignment_evaluate").fadeIn();
    $("#btn_evaluate").hide();
    $("#btn_cancel_evaluation").fadeIn();
    $("#btn_save_evaluation").fadeIn();
  }

  function undo_btn_evaluate_changes(){
    $("#tb_student_assignment_evaluate").hide(); 
    $("#tb_student_assignment").fadeIn();
    $("#btn_cancel_evaluation").hide();
    $("#btn_save_evaluation").hide();
    $("#btn_evaluate").fadeIn(); 
    show_no_itens_div = $('td', '#tb_student_assignment').length == 0;
    if(show_no_itens_div){
      $("#no_itens_evaluation_tb").fadeIn();
    }
  }

  function btn_cancel_evaluation(){
    if (confirm('<%= t(:portfolio_cancel_evaluation) %>')){
      undo_btn_evaluate_changes();  
      flash_message('<%= t(:student_evaluation_canceled) %>', 'notice');
    }
  }

  function btn_save_evaluation(assignment_id, student_id, group_id){
    if (confirm('<%= t(:portfolio_confirm_evaluation) %>')){
     
      var evaluation_grade    = ''+$("#evaluation_grade").attr('value')+'';
      var evaluation_comment  = $("#evaluation_comment").attr('value');
      var url                 = '<%= portfolio_teacher_evaluate_student_assignment_path %>';

      var continue_with_request = true;
      $.ajax({
        url: url,
        type: 'POST',
        data:  {'grade': evaluation_grade, 'assignment_id': assignment_id, 'comment': evaluation_comment, 'student_id': student_id, 'group_id': group_id},
        success: function(data) {
          console.log(data.success);
          if (data.success == false) {
            continue_with_request = false;
            flash_message(data.flash_msg, data.flash_class);
            if (data.cancel == true) {
              undo_btn_evaluate_changes();
            }
          }else{
            $("#evaluate_assignment_student").html(data);
            undo_btn_evaluate_changes();
            flash_message('<%= t(:student_evaluated_success) %>', 'notice');
          }
        }
      });
      return continue_with_request; 
    }

  }

</script>