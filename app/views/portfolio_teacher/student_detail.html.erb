<%= javascript_include_tag "group_assignments" %>

<div>
  <!-- Descricao da atividade -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2>
        <%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %><%= @assignment.name %>
      </h2>
    </div>
    <div id="individual_activity_description" class="block_content">
      <!-- Descricao da atividade -->
      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%">
        <thead>
          <tr class="lines">
            <th><%=t(:activity_description)%></th>
            <th align="right" style="width:70px">
              <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
              <span>
                Início
              </span>
            </th>
            <th align="right" style="width:70px">
              <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
              <span>
                Fim
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="lines" >
            <td>
              <%= @assignment.enunciation %>
            </td>
            <td class="center">
              <%= @assignment.schedule.start_date.strftime("%d/%m/%Y") %> às <%= @assignment.schedule.start_date.strftime("%H:%M") %> 
            </td>
            <td class="center">
              <%= @assignment.schedule.end_date.strftime("%d/%m/%Y") %>  <%= t(:portfolio_date_to) %> <%= @assignment.schedule.end_date.strftime("%H:%M") %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Arquivos enviados pelo aluno -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2>
        <%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %>Arquivos enviados
      </h2>
      <span class="download_all_icon">
        <% unless @files_sent_assignment.empty? %>
          <%= image_tag "mimetypes/zip.png", :alt => " ", :class=>'block_title_icon' %>
          <%= link_to t(:portfolio_download_all_zip), {:controller => :group_assignments, :action => :download_all_files_zip, :all_files => @files_student_assignment, :assignment_id => @assignment.id}, :class => "link_content" %>
        <% end %>
      </span>
    </div>
    <div id="files_assignment_student" class="block_content">
      <% unless @files_sent_assignment.empty? %>
        <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%">
          <thead>
            <tr class="lines">
              <th>Nome</th>
              <th align="right" style="width: 80px">Tamanho</th>
              <% if @assignment.type_assignment == Group_Activity %>
                <th align="right" style="width: 80px">Enviado por</th>
              <% end %>
              <th align="center" style="width:80px">
                <%= image_tag "clock.png", :alt => " ", :class=>"block_title_icon" %>
                <span>
                  Enviado em
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% @files_sent_assignment.each{ |file|  %>
              <tr class="lines" >
                <td>
                  <%= link_to image_tag(icon_attachment(file.attachment_file_name)), {:controller=>:group_assignments, :action=>:download_single_file, 
                                                                          :file_id => file.id, :assignment_id => @assignment.id },
                                                                          {:class => "file_icon", :alt => t(:file_type_icon)} %>
                  <%= link_to file.attachment_file_name, {:controller => :group_assignments, :action => :download_single_file, :file_id => file.id, 
                                              :assignment_id => @assignment.id }, :class => "link_content" %>
                </td>
                <td class="right">
                  <%= format('%.2f KB', file.attachment_file_size/1024.0) %>
                </td>
                <% if @assignment.type_assignment == Group_Activity %>
                  <td class="right">
                    <%= file.user.nick %>
                  </td>
                <% end %>
                <td class="center">
                  <%= file.attachment_updated_at.strftime("%d/%m/%Y") %> às <%= file.attachment_updated_at.strftime("%H:%M") %>
                </td>
              </tr>
            <% } %>      
          </tbody>
        </table>
      <% else %>
        <div class="portfolio_div_padding">
          <%= t(:itens_not_found) %>
        </div>
      <% end %>
    </div>
  </div>

   <!-- Área de avaliação -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2><%= image_tag "icon_participants.png", :alt => " ", :class=>'block_title_icon' %>Avaliação</h2>
      <span class="portfolio_title_button">
        <input id="btn_evaluate" type="button" value='<%=t(:portfolio_evaluate)%>' class="btn btn_main" onclick="btn_evaluate();"/>
        <input id="btn_cancel_evaluation" type="button" value='<%=t(:portfolio_cancel)%>' class="btn btn_caution" style="display:none" onclick="btn_cancel_evaluation();"/>
        <input id="btn_save_evaluation" type="button" value='<%=t(:portfolio_save)%>' class="btn btn_main" style="display:none" onclick="btn_save_evaluation('<%=@assignment.id%>', '<%=@student_or_group.id%>');"/>
      </span>
    </div>
    <div id="evaluate_assignment_student" class="block_content">
      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%" id="tb_student_assignment">
        <% unless @send_assignment.nil? or (@send_assignment.grade.nil? and @send_assignment.comment.nil?) %>
          <thead>
            <tr class="lines">
              <th align="right" style="width:30px"><%= t(:grade) %></th>
              <th><%= t(:comment) %></th>
            </tr>
          </thead>
          <tbody>
              <tr class="lines" >
                <td><%= @send_assignment.grade %></td>
                <td><%= @send_assignment.comment %></td>
              </tr>
          </tbody>
        <% else %>
          <div class="portfolio_div_padding" id="no_itens_evaluation_tb">
            <%= t(:itens_not_found) %>
          </div>
        <% end %>
      </table>

      <table class="tb_list" border="0" cellpadding="0" cellspacing="0" width="100%" id="tb_student_assignment_evaluate" style="display: none">
        <thead>
          <tr class="lines">
            <th align="right" style="width:30px"><%= t(:grade) %></th>
            <th><%= t(:comment) %></th>
          </tr>
        </thead>
        <tbody>
            <tr class="lines" >
              <td><%= text_field_tag :evaluation_grade, @send_assignment.nil? ? "" : @send_assignment.grade, :size => 3 %></td>
              <td><%= text_area_tag :evaluation_comment, @send_assignment.nil? ? "" : @send_assignment.comment, :rows => 4, :cols => 113 %></td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Área de comentários -->
  <div id="activities" class="block_wrapper">
    <div class="block_title">
      <h2><%= image_tag "icon_suitcase_portfolio.png", :alt => " ", :class=>'block_title_icon' %>Comentários</h2>
      <span class="portfolio_title_button">
        <input id="btn_comment" type="button" value='<%=t(:portfolio_comment)%>' class="btn btn_main" onclick="btn_comment();"/>
      </span>
    </div>

    <div id="comment_assignment_student" class="forum_posts_wrapper">
      <% unless @comments.nil? %>
        <% @comments.each_with_index{ |comment, idx| %>
          <table class="forum_post tb_comments" border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
              <td rowspan="3" class="forum_post_icon">
                <%#= image_tag "no_image_forum.png", :alt => " ", :class=>'block_title_icon' %>
                <%= image_tag(@user.photo.url(:forum), :alt => t(:mysolar_alt_img_user) + ' ' + @user.nick) %>
              </td>
              <td class="forum_post_head">
                <div class="forum_post_author">
                  <div class="forum_participant_nick" alt="fulano">
                    <%= @user.nick %>
                  </div>
                  <div class="forum_participant_profile" >
                    <%= @user_profile.name %>
                  </div>
                </div>
                <div class="forum_post_date">
                  Data de postagem do comentário de fulano
                </div>
              </td>
            </tr>
            <tr>
              <td class="forum_post_content" colspan="2">
                <div class="forum_post_inner_content">
                  <%= comment.comment %>
                </div>
                <div class="forum_post_attachment">
                  <h3>
                    Anexos
                  </h3>
                  <ul class="forum_post_attachment_list">
                    <% @comments_files[idx].each{| comment_file | %>
                      <li>
                        <%= link_to comment_file.attachment_file_name, {:controller => :group_assignments, :action => :download_single_file,                                    :file_id => comment_file.id, :assignment_id => @assignment.id }, :class => "link_content" %>
                      </li>
                    <% } %>  
                    <button type="button" class="btn btn_default" onclick="showImportGroupBox('<%= url_for(:controller => :portfolio_teacher, :action => :upload_files_comment_page, :id => comment.id, :assignment_id => @assignment.id, :student_id => @send_assignment.user_id)%>', '');">Anexar arquivo<img alt="Anexar arquivo" src="/assets/icon_attachment.png"></button>
                  </ul>
                </div>
              </td>
            </tr>
            <tr></tr>
          </table>
        <% } %>
      <% else %>
        <div id="no_itens_message_comment" class="block_content portfolio_div_padding">
          <%= t(:itens_not_found) %>
        </div>
      <% end %>    
    </div>
  </div>

<script type="text/javascript">

// Comentários

 function btn_comment(){
    $("#no_itens_comments_tb").hide();
    $("#btn_comment").hide();
    new_comment_div();
  }

  function undo_btn_comment_changes(){
    $("#tb_send_comments").hide(); 
    $("#btn_comment").fadeIn(); 
    $(".new_comment").remove();
    show_no_itens_div = $('td', '#tb_comments').length == 0;
    if(show_no_itens_div){
      $("#no_itens_comments_tb").fadeIn();
    }
  }

  function new_comment_div(){
    var new_comment_div = new Array();
    var already_have_comments = $('.tb_comments').length != 0;

    new_comment_div.push('<table class="forum_post new_comment tb_comments" border="0" cellpadding="0" cellspacing="0" width="100%">');
      new_comment_div.push('<tr>');
        new_comment_div.push('<td rowspan="3" class="forum_post_icon">');
          new_comment_div.push('<img src="/assets/no_image_forum.png" alt=" " class="block_title_icon" />');
        new_comment_div.push('</td>');
        new_comment_div.push('<td class="forum_post_head">');
          new_comment_div.push('<div class="forum_post_author">');
            new_comment_div.push('<div class="forum_participant_nick" alt="fulano">');
              new_comment_div.push('nick');
            new_comment_div.push('</div>');  
            new_comment_div.push('<div class="forum_participant_profile" alt="fulano">');
              new_comment_div.push('perfil');
            new_comment_div.push('</div>');  
          new_comment_div.push('</div>');
          new_comment_div.push('<div class="forum_post_date">');
            new_comment_div.push('data de hoje');
          new_comment_div.push('</div>');  
        new_comment_div.push('</td>');
      new_comment_div.push('</tr>');  
      new_comment_div.push('<tr>');
        new_comment_div.push('<td class="forum_post_content" colspan="2">');
          new_comment_div.push('<div class="forum_post_inner_content">');
            new_comment_div.push('<textarea rows="4" cols="116" id="comments_comment" name="comments_comment" type="text"/>');
          new_comment_div.push('</div>');
          new_comment_div.push('<div class="portfolio_title_button">');
            new_comment_div.push('<input id="btn_cancel_comment" type="button" value=\'<%=t(:portfolio_cancel)%>\' class="btn btn_caution" onclick="btn_cancel_comment();"/>');
            new_comment_div.push('<input id="btn_save_comment" type="button" value=\'<%=t(:portfolio_save)%>\' class="btn btn_main"  onclick="btn_save_comment(\'<%=@assignment.id%>\', \'<%=@student_or_group.id%>\');"/>');
          new_comment_div.push('</div>');
        new_comment_div.push('</td>');
      new_comment_div.push('</tr>');
    new_comment_div.push('</table>');

    $(new_comment_div.join("")).appendTo($("#comment_assignment_student"));

    if(!already_have_comments){
      $("#no_itens_message_comment").remove();
    }

  }

  function btn_cancel_comment(){
    if (confirm('<%= t(:portfolio_cancel_comment) %>')){
      undo_btn_comment_changes();  
      flash_message('<%= t(:comment_canceled) %>', 'notice');
      var dont_have_comments = $('.tb_comments').length == 0;
      if(dont_have_comments){
        $('<div id="no_itens_message_comment" class="block_content portfolio_div_padding"><%= t(:itens_not_found) %></div>').appendTo($("#comment_assignment_student"));
      }
    }
  }

  function btn_save_comment(assignment_id, student_id){
    if (confirm('<%= t(:portfolio_confirm_comment) %>')){
     
      var comments_comment      = $("#comments_comment").attr('value');
      var comments_files        = $(".comments").map(function(){return ''+this.value+''});
      var continue_with_request = true;
      var url                   = '<%= portfolio_teacher_update_comment_path %>';
      var comments_files_names  = new String();

        for (var i = 0; i < comments_files.length; i++){
          if(i != 0){ comments_files_names += ";"; }
          if(comments_files[i] != ""){
            comments_files_names += comments_files[i];
          }
        }

      $.ajax({
        url: url,
        type: 'POST',
        data:  {'comment': comments_comment, 'assignment_id': assignment_id, 'files_names': comments_files_names, 'student_id': student_id},
        success: function(data) {
          if (data.success == false) {
            continue_with_request = false;
            flash_message(data.flash_msg, data.flash_class);
          }else{
            $("#comment_assignment_student").html(data);
            undo_btn_comment_changes();
            flash_message('<%= t(:comment_sent_success) %>', 'notice');
          }
        }
      });
      return continue_with_request; 
    }
  }

// Avaliação

  function btn_evaluate(){
    $("#tb_student_assignment").hide();
    $("#no_itens_evaluation_tb").hide();
    $("#tb_student_assignment_evaluate").fadeIn();
    $("#btn_evaluate").hide();
    $("#btn_cancel_evaluation").fadeIn();
    $("#btn_save_evaluation").fadeIn();
  }

  function undo_btn_evaluate_changes(){
    $("#tb_student_assignment_evaluate").hide(); 
    $("#tb_student_assignment").fadeIn();
    $("#btn_cancel_evaluation").hide();
    $("#btn_save_evaluation").hide();
    $("#btn_evaluate").fadeIn(); 
    show_no_itens_div = $('td', '#tb_student_assignment').length == 0;
    if(show_no_itens_div){
      $("#no_itens_evaluation_tb").fadeIn();
    }
  }


  function btn_cancel_evaluation(){
    if (confirm('<%= t(:portfolio_cancel_evaluation) %>')){
      undo_btn_evaluate_changes();  
      flash_message('<%= t(:student_evaluation_canceled) %>', 'notice');
    }
  }

  function btn_save_evaluation(assignment_id, student_id){
    if (confirm('<%= t(:portfolio_confirm_evaluation) %>')){
     
      var evaluation_grade    = $("#evaluation_grade").attr('value');
      var evaluation_comment  = $("#evaluation_comment").attr('value');
      var url                 = '<%= portfolio_teacher_evaluate_student_assignment_path %>';

      var continue_with_request = true;
      $.ajax({
        url: url,
        type: 'POST',
        data:  {'grade': evaluation_grade, 'assignment_id': assignment_id, 'comment': evaluation_comment, 'student_id': student_id},
        success: function(data) {
          if (data.success == false) {
            continue_with_request = false;
            flash_message(data.flash_msg, data.flash_class);
          }else{
            $("#evaluate_assignment_student").html(data);
            undo_btn_evaluate_changes();
            flash_message('<%= t(:student_evaluated_success) %>', 'notice');
          }
        }
      });
      return continue_with_request; 
    }

  }

</script>