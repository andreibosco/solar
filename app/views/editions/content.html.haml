= javascript_include_tag "autocomplete"
= stylesheet_link_tag "jquery-ui-autocomplete", "autocomplete"

.edition
  %fieldset#allocation_tag_selection
    %legend= t(".filter")
    .filter_notice= t(".select_something")
    .filter
      = label_tag :curriculum_unit_type, t(".type")
      = select_tag :curriculum_unit_type, options_from_collection_for_select(@types, "id", "description"), include_blank: true

      %br/
      = label_tag :course, t(".course")
      / = select_tag :course, options_from_collection_for_select(@courses, "id", "code_name"), include_blank: true
      = select_tag :course, nil
      //- if @type.id != 3 # criar uma CONSTANTE

      %br/
      = label_tag :curriculum_unit, t(".curriculum_unit")
      = select_tag :curriculum_unit, nil

      %br/
      = label_tag :semester, t(".semester")
      = select_tag :semester, nil

      %br/
      = radio_button :radio, :option, "offer", disabled: true
      = label_tag :radio_option_offer, t(".offer")

      = radio_button :radio, :option, "group", disabled: true
      = label_tag :radio_option_group, t(".group")

      %br/
      .groups

      %br/
      = link_to t(:search), "#", {class: "btn btn_main", :"data-url-search" => items_editions_path, id: "search", :"data-load-to" => "items_list"}

.items_list

:javascript

  function clear_combo(combo_name, disable) {
    $('#' + combo_name).combobox('value', null);
    $('#' + combo_name).combobox("option", { disabled: disable });
  }

  function clear_all_combos(disable) {
    $(".groups").html('');
    clear_combo("course", disable);
    clear_combo("curriculum_unit", disable);
    clear_combo("semester", disable);
  }

  function update_combobox(url, combobox){
    $.get(url, function(data){
      $("#"+combobox).html(data.html);
    });
  }

  $(function(){
    $("#curriculum_unit_type, #course, #curriculum_unit, #semester").combobox();
    $("#course, #curriculum_unit, #semester").combobox( "option", { disabled: true } );

    $( "#curriculum_unit_type" ).combobox({
      change: function(event, ui) {
        if(ui.item == null)
          clear_all_combos(true);
      },
      select: function( event, ui ) {
        clear_all_combos(true);
        $('#course').combobox("option", { disabled: false });
        $(".groups").html('');
        var url = "#{list_combobox_courses_path(type_id: 'type_param')}".replace('type_param', $('#curriculum_unit_type').combobox('value'));
        $('#course').combobox("update", {url: url});
      }
    });

    $( "#course" ).combobox({
      change: function(event, ui) {
        if(ui.item == null){
          clear_combo('curriculum_unit', true);
          clear_combo('semester', true);
          $(".groups").html('');
        }
      },
      select: function( event, ui ) { 
        clear_combo('curriculum_unit', false);
        clear_combo('semester', true);
        $(".groups").html('');
        var url = "#{list_combobox_curriculum_units_path(type_id: 'type_param', course_id: 'course_param')}".replace('type_param', $('#curriculum_unit_type').combobox('value')).replace('course_param', $('#course').combobox('value'));
        $('#curriculum_unit').combobox("update", {url: url});
      }
    });

    $( "#curriculum_unit" ).combobox({
      change: function(event, ui) {
        if(ui.item == null){
          clear_combo('semester', true);
          $(".groups").html('');
        }
      },
      select: function( event, ui ) { 
        clear_combo("semester", false);
        $(".groups").html('');
        var url = "#{list_combobox_semesters_path(period: "all", course_id: "course_param", curriculum_unit_id: "curriculum_unit_param")}".replace("course_param", $("#course").combobox("value")).replace("curriculum_unit_param", $("#curriculum_unit").combobox("value"));
        $('#semester').combobox("update", {url: url});
      }
    });

    $( "#semester" ).combobox({
      change: function( event, ui ) {
        if(ui.item == null){
          $("input[id^=radio_option]").prop("disabled", true);
          $("#radio_option_offer").click();
        }
      },
      select: function( event, ui ) { 
        $("#radio_option_offer").click();
        $("input[id^=radio_option]").prop("disabled", false);
      }
    });


    // ----------------------------------------------------------------------------------------------------


    $("#radio_option_group").click(function(){
      var url = "#{list_groups_path(checkbox: true , semester_id: "semester_param", course_id: "course_param", curriculum_unit_id: "curriculum_unit_param")}"
        .replace("semester_param", $("#semester").combobox("value"))
        .replace("course_param", $("#course").combobox("value"))
        .replace("curriculum_unit_param", $("#curriculum_unit").combobox("value"));

      $.get(url, function(data){
        $(".groups").html(data);
      });
    });

    $("#radio_option_offer").click(function() {
      $(".groups").html('');
      $("#radio_option_offer").prop("checked", true);
    });

    $(".edition").nice_filter({
      data_function: function() {
        return {groups_id: $('[name="group[group_id][]"]:checked').map(function(){ return $(this).val() }).toArray()};
      }
    });

  });
