<%= javascript_include_tag 'group_assignments.js' %>

<div class="block_wrapper" id="group_assignments">

  <div class="block_title">
    <h2><%= image_tag "icon_suitcase_portfolio.png", :alt => t(:portfolio_icon), :class=>'block_title_icon' %><%= t(:group_assignments)%></h2>
  </div>

  <div class="block_content" id="group_assignments">

    <% unless @assignments.nil? or @assignments.empty? %>
      <table class="tb_list">
        <tbody>
        <% @assignments.each do |a| %>
          <tr class="lines">
            <td>
              <div class="group_assignment_title" onClick="javascript:toggle_div('div_assignment_<%=a["id"]%>');">
                <a id="<%=a["id"].to_i%>" class="link_content"><%=a["name"]%></a>
              </div>
              <% gps = group_assignments(a["id"])%>
              <div id="div_assignment_<%=a["id"]%>" class="group_assignment_details">

                <div class="group_assignment_content"><%=a["enunciation"]%></div>

                <h3><%= t(:group_assignment_date)%></h3>
                <div class="group_assignment_content"><%= a["start_date"] %> - <%= a["end_date"] %></div>

                <h3><%= t(:group_assignment_title)%></h3>
                <div class="group_assignment_content" id="group_assignment_content_<%=a["id"]%>">

                  <% unless gps.nil? or gps.empty? %>
                    <% gps.each do |g| %>
                      <div class="group_participants" id="group_<%=g['id']%>">
                        <h3 class="group_assignment_name" id="group_name_<%=g["id"]%>"><%= g["group_name"] %></h3>
                        <div id="edit_group_<%=g["id"]%>" style="display:none;">
                          <%= text_field_tag "new_groups_names[][#{a["id"]}]", g["group_name"], :id => g["id"], :class => "rename_group" %>
                          <% group_has_files = !SendAssignment.find_all_by_group_assignment_id(g["id"]).empty? %>
                          <% data_tooltip = !group_has_files ? nil : t(:group_assignment_delete_error) %>
                          <a class="" onclick="delete_group('group_<%=g['id']%>', <%=a['id']%>, <%=group_has_files%>);" data-tooltip="<%=data_tooltip%>">x</a>
                        </div>
                        <% gp = group_participants(g["id"])%>
                        <ul value="<%=g['id']%>" name="groups_ul">
                          <% unless gp.empty? %>
                            <% gp.each do |p| %>
                              <% can_be_moved = SendAssignment.find_all_by_group_assignment_id_and_user_id(g["id"], p["user_id"]).empty? %>
                              <% data_tooltip = can_be_moved ? nil : t(:student_already_sent_files) %>
                              <li value="<%=p['user_id']%>" id="<%=can_be_moved%>" data-tooltip="<%=data_tooltip%>" onmouseover="student_mouseover(this, '<%=t(:student_already_sent_files)%>');" onmouseout="student_mouseout(this);"><%= p["name"] %>
                            <% end %>
                          <% else %>
                            <li id="no_students_message"><%= t(:no_participant_group_assignment) %></li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  <% end %>

                  <% students_without_group = no_group_students(a["id"].to_i) %>
                  <div class="group_participants">
                    <h3 class="group_assignment_name"><%= t(:students_with_no_group) %></h3>
                    <%= hidden_field_tag "new_groups_names[][#{a["id"]}]", 'no_group', :class => "rename_group" %>
                      <ul id='ul_no_group'>
                        <% unless students_without_group.nil? or students_without_group.empty? %>
                          <% students_without_group.each do |student_without_group| %>
                            <li value="<%=student_without_group.id%>" id="true" onmouseover="student_mouseover(this, 'no_message');" onmouseout="student_mouseout(this);"><%= student_without_group.name %></li>
                          <% end %>
                        <% else %>
                          <li id="no_students_message"><%= t(:no_participant_group_assignment) %></li>
                        <% end %>
                      </ul>
                  </div>
                </div>

                <div class="group_assignment_buttons">

                    <input type="button" id='edit_group_assignment_<%=a["id"]%>' value='<%=t(:manage_groups_assignments)%>' class="btn btn_default" onclick="btn_manage_groups('<%=a["id"]%>');"/>

                    <span id='btn_import_<%=a["id"]%>' style='display: none;'>
                      <% if verify_group_of_assignments(a["id"]) %>
                        <input type="button" id='import_to_<%=a["id"]%>' value='<%=t(:group_assignment_import)%>' class="btn btn_default" onclick="showImportGroupBox('<%= url_for(:controller => :group_assignments, :action => :import_groups_page, :id => GroupAssignment.first.id, :assignment_id => a["id"].to_i)%>', '');"/>
                      <% end %>
                    </span>

                    <input type="button" id='new_group_assignment_<%=a["id"]%>' value='<%=t(:group_assignment_new)%>' class="btn btn_default" onclick="btn_new_group('<%=a["id"]%>', '<%= t(:no_participant_group_assignment) %>');" style="display: none;"/>

                    <input type="button" value="<%= t(:group_assignment_save) %>" class="btn btn_main" onclick="btn_save('<%=a["id"]%>');" id='save_changes_assignment_<%=a["id"]%>' style="display:none;"/>

                    <input type="button" id='cancel_changes_assignment_<%=a["id"]%>' value='<%=t(:group_assignment_cancel)%>' class="btn btn_caution" onclick="btn_cancel('<%=a["id"]%>');" style="display: none;"/>

                </div>
              </div>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="block_content block_content_text"><%= t(:itens_not_found) %></div>
    <% end %>

  </div>

</div>

<script type="text/javascript">

  // Variáveis

  var deleted_groups = new Array();

  // Métodos

  $(".group_assignment_title").click(function(){
    $(this).toggleClass('group_assignment_title_contract');
  })

  function put_empty_message(assignment_div){
    // recupera todos os grupos da atividade
    var all_groups = $('ul', assignment_div);
    for(var i = 0; i<all_groups.length; i++){
      var all_participants_each_group = $('li', all_groups[i]);
      // quando ele estiver vazio, acrescenta uma mensagem informativa
      if(all_participants_each_group.length == 0){
        $('<li id="no_students_message"><%= t(:no_participant_group_assignment) %></li>').appendTo(all_groups[i]);
      }
    }
  }

  // Botões

  function btn_cancel(assignment_id){
    if (confirm('<%= t(:group_assignment_confirm_cancel) %>')){
      var continue_with_request = true;
      $.ajax({
        url: url,
        type: 'PUT',
        data:  {'btn_cancel': 'cancel', 'assignment_id': assignment_id},
        success: function(data) {
          $('#group_assignment_content_' + assignment_id).html(data);
          undo_btn_manage_groups_divs_changes(assignment_id, 'cancel');
          // mostra mensagem
          flash_message('<%= t(:group_assignment_cancel_message) %>', 'notice');
        }
      });
      return continue_with_request; 
    }
  }

  function btn_save(assignment_id) {
    if (confirm('<%= t(:group_assignment_confirm_save) %>')){
      var groups = $(".group_participants ul", $('#div_assignment_' + assignment_id));
      var text_fields = $(".rename_group", $('#div_assignment_' + assignment_id));
      var groups_to_save = new Array();

      for (var i = 0; i < groups.length; i++) {
        var groups_names = $(text_fields[i]).map(function(){return this.value});
        var each_group_students_ids = $('li', groups[i]).map(function(){
          if(this.id != 'no_students_message'){return this.value}});

        groups_to_save.push({
          'group_id'   : $(groups[i]).attr('value'),
          'group_name' : groups_names,
          'student_ids': each_group_students_ids
        });
      } // for -> groups

      var continue_with_request = true;
      url = '<%= manage_groups_group_assignments_path %>'
      $.ajax({
        url: url,
        type: 'POST',
        data:  {'groups': groups_to_save, 'assignment_id': assignment_id, 'deleted_groups_divs_ids': deleted_groups},
        success: function(data) {
          if (data.success == false) {
            continue_with_request = false;
            flash_message(data.flash_msg, data.flash_class);
          }else{
            $('#group_assignment_content_' + assignment_id).html(data);
            undo_btn_manage_groups_divs_changes(assignment_id, 'save');
            flash_message('<%= t(:group_assignment_management_success) %>', 'notice')
          }
        }
      });
      return continue_with_request; 
    }
  }

</script>