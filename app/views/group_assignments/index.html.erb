<%= javascript_include_tag 'group_assignments.js' %>

<div class="block_wrapper" id="group_assignments">

  <div class="block_title">
    <h2><%= image_tag "icon_suitcase_portfolio.png", :alt => t(:portfolio_icon), :class=>'block_title_icon' %><%= t(:group_assignments)%></h2>
  </div>

  <div class="block_content" id="group_assignments">

    <% unless @assignments.nil? or @assignments.empty? %>
      <table class="tb_list">
        <tbody>
        <% @assignments.each do |a| %>
          <tr class="lines">
            <td>
              <div class="group_assignment_title" onClick="javascript:toggle_div('div_assignment_<%=a["id"]%>');">
                <a id="<%=a["id"].to_i%>" class="link_content"><%=a["name"]%></a>
              </div>
              <% gps = group_assignments(a["id"])%>
              <div id="div_assignment_<%=a["id"]%>" class="group_assignment_details">

                <div class="group_assignment_content"><%=a["enunciation"]%></div>

                <h3><%= t(:group_assignment_date)%></h3>
                <div class="group_assignment_content"><%= a["start_date"] %> - <%= a["end_date"] %></div>

                <h3><%= t(:group_assignment_title)%></h3>
                <div class="group_assignment_content">

                  <% unless gps.nil? or gps.empty? %>
                    <% gps.each do |g| %>
                      <div class="group_participants" id="group_<%=g['id']%>">
                        <h3 class="group_assignment_name" id="group_name_<%=g["group_name"].tr(' ', '')%>"><%= g["group_name"] %></h3>
                        <div id="edit_group_<%=g["group_name"].tr(' ', '')%>" style="display:none;">
                          <%= text_field_tag "new_groups_names[][#{a["id"]}]", g["group_name"], :id => g["group_name"].tr(' ', '') ,:class => "rename_group" %>

                          <% group_has_files = !SendAssignment.find_all_by_group_assignment_id(g["id"]).empty? %>
                          <% data_tooltip = t(:group_assignment_delete_error) unless !group_has_files %>
                          <a class="" onclick="delete_group('group_<%=g['id']%>', <%=a['id']%>);" data-tooltip="<%=data_tooltip%>">x</a>

                        </div>
                        <% gp = group_participants(g["id"])%>
                        <ul value="<%=g['id']%>" name="groups_ul">
                          <% unless gp.empty? %>
                            <% gp.each do |p| %>
                              <li value="<%=p['user_id']%>"><%= p["name"] %>
                            <% end %>
                          <% else %>
                            <li id="no_students_message"><%= t(:no_participant_group_assignment) %></li>
                          <% end %>
                        </ul>

                      </div>
                    <% end %>
                  <% end %>

                  <% students_without_group = no_group_students(a["id"].to_i) %>
                  <div class="group_participants">
                    <h3 class="group_assignment_name"><%= t(:students_with_no_group) %></h3>
                    <%= hidden_field_tag "new_groups_names[][#{a["id"]}]", 'no_group' ,:class => "rename_group" %>
                      <ul id='ul_no_group'>
                        <% unless students_without_group.nil? or students_without_group.empty? %>
                          <% students_without_group.each do |student_without_group| %>
                            <li value="<%=student_without_group.id%>"><%= student_without_group.name %></li>
                          <% end %>
                        <% else %>
                          <li id="no_students_message"><%= t(:no_participant_group_assignment) %></li>
                        <% end %>
                      </ul>
                  </div>
                </div>

                <div class="group_assignment_buttons">

                    <!-- \/ se houver grupos (a definir regra) \/ -->
                    <input type="button" id='edit_group_assignment_<%=a["id"]%>' value='<%=t(:manage_groups_assignments)%>' class="btn btn_default" onclick="btn_edit('<%=a["id"]%>');"/>

                    <span id='btn_import_<%=a["id"]%>' style='display: none;'>
                      <% if verify_group_of_assignments(a["id"]) %>
                        <input type="button" id='import_to_<%=a["id"]%>' value='<%=t(:group_assignment_import)%>' class="btn btn_default" onclick="showImportGroupBox('<%= url_for(:controller => :group_assignments, :action => :import_groups_page, :id => GroupAssignment.first.id, :assignment_id => a["id"].to_i)%>', '');"/>
                      <% end %>
                    </span>

                    <input type="button" id='new_group_assignment_<%=a["id"]%>' value='<%=t(:group_assignment_new)%>' class="btn btn_default" onclick="btn_new_group('<%=a["id"]%>');" style="display: none;"/>

                    <input type="button" value="<%= t(:group_assignment_save) %>" class="btn btn_main" onclick="btn_save('<%=a["id"]%>');" id='save_changes_assignment_<%=a["id"]%>' style="display:none;"/>

                    <input type="button" id='cancel_changes_assignment_<%=a["id"]%>' value='<%=t(:group_assignment_cancel)%>' class="btn btn_caution" onclick="btn_cancel('<%=a["id"]%>');" style="display: none;"/>
                    <!-- /\ se houver grupos (a definir regra) /\ -->

                </div>
                
              </div>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="block_content block_content_text"><%= t(:itens_not_found) %></div>
    <% end %>
   
  </div>

</div>

<script type="text/javascript">

  $(".group_assignment_title").click(function(){
    $(this).toggleClass('group_assignment_title_contract');
  })

  function btn_edit(assignment_id, div_group){
    group_name_to_text_field(assignment_id);
    $('#edit_group_assignment_'+assignment_id).hide();
    $('#save_changes_assignment_'+assignment_id).show();
    $('#cancel_changes_assignment_'+assignment_id).show();
    $('#cancel_changes_assignment_'+assignment_id).show();
    $('#new_group_assignment_'+assignment_id).show();
    $('#btn_import_'+assignment_id).show();
    dragndrop($('#div_assignment_'+assignment_id));
  }

  function btn_cancel(assignment_id){
    if (confirm('Quer cancelar todas as alterações?')){
      // $('#group_assignment_content').append('<input type="hidden_field" id="assignment_id" name="assignment_id" value='+assignment_id+'/>;');
      document.location.href='<%=group_assignments_path%>'; //EVITAR USAR DOCUMENT -> USAR JQUERY
      // $(document).attr('href', '<%= group_assignments_path %>');
      //recarrega página com o assignment em questão aberto. :|
    }
  }

  function btn_new_group(assignment_id) {
    var new_idx = "group_new_" + $('.another_new_group').length;

    var new_group_hmtl = new Array();
    new_group_hmtl.push('<div class="group_participants another_new_group" id="' + new_idx + '">');
      new_group_hmtl.push('<div id="edit_group_new">');
        new_group_hmtl.push('<input type="text_field" name="new_groups_names[][' + assignment_id + ']" class="rename_group" />');
        new_group_hmtl.push('<a onclick="delete_group(\'' + new_idx + '\', \'' + assignment_id + '\');">x</a>');
      new_group_hmtl.push('</div>');
      new_group_hmtl.push('<ul value="0">');
      new_group_hmtl.push('</ul>');
    new_group_hmtl.push('</div>');

    $(new_group_hmtl.join('')).appendTo($('.group_assignment_content', $('#div_assignment_'+assignment_id)).last());

    var new_group_ul = $('.group_participants ul', $('#div_assignment_'+assignment_id)).last();
    active_droppable_element(new_group_ul, $('#div_assignment_'+assignment_id));

  }

  function group_name_to_text_field(assignment_id){
    var all_groups = document.getElementsByName("new_groups_names[]["+assignment_id+"]");
    for(var i = 0; i < all_groups.length; i++) {
      $('#group_name_'+all_groups[i]['id']).hide();
      $('#edit_group_'+all_groups[i]['id']).fadeIn();  
    }
  }

  function delete_group(group_id, assignment_id) {
    console.log(group_id);
    var deleted_div = $('#'+group_id);
    var all_li = $('li', deleted_div);
    for (var i = 0; i < all_li.length; i++){
      $(all_li[i]).appendTo($('#ul_no_group'));
    }
    deleted_div.remove();
  }

  function dragndrop(assignment_div){
    active_draggable_element($(".group_participants li", assignment_div));
    active_droppable_element($( ".group_participants ul", assignment_div), assignment_div);
  }

  function active_draggable_element(obj) {
    obj.draggable({
      cursor: "move",
      revert: true
    });
  }

  function active_droppable_element(obj, assignment_div) {
    obj.droppable({
      accept: ".group_participants li",
      // activeClass: "ui-state-highlight",
      drop: function( event, ui ) {
        var participant_id = ui.draggable.attr('value');
        // remove o elemento draggable da lista que esta sendo movido
        ui.draggable.remove();
        $( "<li value='"+participant_id+"' style='position: relative; ' class='ui-draggable'></li>" ).text( ui.draggable.text() ).appendTo(this);
        
        if($('#no_students_message', this)){
          $('#no_students_message', this).remove();
        }
        // if($()) a div ul tá vazia, daí tem que colocar mensagem

        // define como draggable o novo elemento criado
        active_draggable_element($(".group_participants li", assignment_div));
      }
    });
  }

  function btn_save(assignment_id) {
    var groups = $(".group_participants ul", $('#div_assignment_' + assignment_id));
    var text_fields = $(".rename_group", $('#div_assignment_' + assignment_id));
    var groups_to_save = new Array();

    for (var i = 0; i < groups.length; i++) {
      // var groups_names = $(text_fields[i]).attr('value');
      var groups_names = $(text_fields[i]).map(function(){return this.value});
      var each_group_students_ids = $('li', groups[i]).map(function(){return this.value});

      groups_to_save.push({
        'group_id'   : $(groups[i]).attr('value'),
        'group_name' : groups_names,
        'student_ids': each_group_students_ids
      });

    }
          var url = '../group_assignments/update/1?assignment_id='+assignment_id;
          var params = '';
          $.ajax({
            url: url,
            type: 'PUT',
            dataType: "html",
            data:  {'groups': groups_to_save, 'assignment_id': assignment_id}
            // success: function(data) {
            //   if (data.success == false) {
            //     continue_with_request = false;
            //   }
            //   flash_message(data.flash_msg, data.flash_class);
            // }
          });
    // console.log(document.getElementsByName('new_groups_names[][4]').map(function(){return this.value}));
  }

// groups_to_send[0]['student_ids']
// groups_to_send[0]['group_name']

</script>