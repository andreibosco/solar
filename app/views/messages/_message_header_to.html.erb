<div class="message_header_new">
  <table border="0" cellpadding="5" cellspacing="0" width="100%">
    <tbody>
      <tr>
        <td class="message_text_to" align="right" style="width:75px">
          <a class="link_content" href="javascript:show_div('link_to_contacts','div_contacts')" id="link_to_contacts"><%=t(:message_to)%></a>
        </td>
        <td class="message_text_to"><%= text_field_tag  'to', @target, :class=> "message_search_textbox", :readonly => true, :onclick => "javascript:show_div('link_to_contacts','div_contacts')" %></td>
      </tr>
      <tr>
        <td class="message_text_to" align="right" style="width:75px"><%=t(:message_subject)%></td>
        <td class="message_text_to"><%= text_field_tag  'subject', @subject, :class=> "message_search_textbox" %></td>
      </tr>
      <tr>
        <td class="message_text_to" align="right" style="width:75px">&nbsp;</td>
        <td class="message_text_to">
          <% unless @files.nil? %>
            <% @files.each do |f| %>
               <%= image_tag("message_file.png",:alt=>t(:message_attach))+f.message_file_name %><br/>
            <% end %>
            <%= raw "<br/>"%>
          <% end %>
          <div id="newPostUploadPanel"><a href="#" id="link_upload" class="message_link" onclick="appendFileField(); return false;"><%=t(:message_attach_file)%></a></div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div style="display:none" id="div_contacts">
  <% if !@curriculum_units_user.nil? %>

    <select id="curriculum_unit_select" style="width:440px">
      <option value="" <%=" selected=true " unless !@curriculum_units_name.nil?%> ><%=t(:message_personal_contacts)%></option>
      <% @curriculum_units_user.each do |curriculum_unit| %>
        <% offer_id = curriculum_unit["offer_id"].nil? ? "" : curriculum_unit["offer_id"] %>
        <% group_id = curriculum_unit["group_id"].nil? ? "" : curriculum_unit["group_id"] %>
        <option value="<%=curriculum_unit["id"] << ';' << offer_id << ';' << group_id %>" <%=" selected=true " unless @curriculum_units_name!=curriculum_unit["name"]%> ><%=curriculum_unit["name"]%></option>
      <% end %>
    </select>
  <% end %>

  <br/><br/>
  <%= label_tag "", t(:message_select)+': ' %><br/>

  <div id="div_contacts_list">
    <%=raw @contacts%>
  </div>
  <br/>
  <%= label_tag "", t(:message_to)+': ' %><br/>
  <div id="recipients_selected"><%= raw @target_html unless @target.empty? %></div>
  <span class="invisible" id="older_recipients"><%= raw @target_html unless @target.empty? %></span>
  <div class="div_contacts_buttons">
    <span id="link_confirm_contacts" border="0" class="link_button"><%=t(:message_complete)%></span>
    <span id="link_cancel_contacts" border="0" class="link_button"><%=t(:message_cancel)%></span>
  </div>
</div>

<script type="text/javascript">

  $(function($) {

    $("#curriculum_unit_select").change(function() {
      $("#div_contacts_list").load("/messages/ajax_get_contacts/",{data: this.value})
    })

    $("#link_cancel_contacts").click(function() {
      $("#div_contacts").hide();
      //volta destinatarios
      $("#recipients_selected").html($("#older_recipients").html());
      $("#div_contacts_list > span").show();
    })

    $("#link_confirm_contacts").click(function() {
      $("#div_contacts").hide();
      //older_recipients guarda os destinatarios atuais
      $("#older_recipients").html($("#recipients_selected").html());
      $("#to").val($("#recipients_selected").text());
    })

  });

  function show_div(origin,elementId) {
    var posx =$('#'+origin).offset().left + 38;
    var posy =$('#'+origin).offset().top - 2;

    $('#'+ elementId).css({"left":posx});
    $('#'+ elementId).css({"top":posy});
    $('#'+ elementId).show();
  }

  function add_receiver(u,name,email){
    new_to = name + " [" + email + "], ";
    var new_recipient = "<span onclick="+"$('#"+u+"').show();$(this).remove()" + " class='message_recipient_box' >"+new_to+"</span>";

    var atual_recipients = $("#recipients_selected").text();
    var found = atual_recipients.search(email);
    if (found == -1) {
      $("#recipients_selected").append(new_recipient);
      $("#"+u).hide();
    }
  }

  //// Manipulação de arquivos anexos ///////////////////////////////
  var numFileFields = 0;
  function appendFileField(){
    var cancel_text = "<%=t(:message_cancel)%>"
    newElementId = 'attachment_' + numFileFields;
    newElementName = 'attachment[' + numFileFields + ']';
    newElement = '<div id="'+ newElementId +'_container">';
    newElement += '<input id="' + newElementId + '" type="file" name="' + newElementName + '" style="display:none;"/>';
    newElement += ' <a href="#" class="message_link" onclick="removeFileField(\''+newElementId+'\');return false;">' + cancel_text + '</a>';
    newElement += '</div>';
    $("#link_upload").after(newElement)
    $("#"+newElementId).slideDown('fast');//exibindo campo de upload
    numFileFields++;
  }

  function removeFileField(fieldId){
    $("#"+fieldId+"_container").hide('fast', function(){
      $("#"+fieldId+"_container").remove();
    });
  }

</script>