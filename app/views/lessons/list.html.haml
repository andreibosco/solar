= hidden_field_tag(:allocation_tag_id, params[:allocation_tag_id]) 

.block_wrapper
  - unless @lesson_modules.nil? or @lesson_modules.empty?

    - @lesson_modules.each_with_index do |m, idxm|
      - lessons = lessons_by_module(m.id)

      .block_title
        %h2
          = link_to (image_tag "/assets/lesson/up_arrow.png", :alt => ''), "#", :onclick => "javascript: alert('sobe');", :id => 'up', :class => 'lesson_arrow' unless idxm == 0
          = link_to (image_tag "/assets/lesson/down_arrow.png", :alt => ''), "#", :onclick => "javascript: alert('desce');", :id => 'down', :class => 'lesson_arrow' unless idxm == @lesson_modules.count-1
          =m.name
          = link_to (image_tag "/assets/lesson/edit.png", :alt => ''), "#", :onclick => "javascript: alert('abrir edicao de modulo');", :id => 'edit_module'
          = link_to (image_tag "/assets/lesson/delete.png", :alt => ''), "#", :onclick => "javascript: alert('excluir modulo');", :id => 'delete_module'

      .block_content.block_content_text.block_content_toolbar
        .block_content_toolbar_left
          = link_to (image_tag "/assets/lesson/add_lesson.png", :alt => ''), "#", :onclick => "javascript: alert('nova aula');", :id => 'new_lesson'
          = link_to (image_tag "/assets/lesson/import_lesson.png", :alt => ''), "#", :onclick => "javascript: alert('importar aula');", :id => 'import_lesson'

        .block_content_toolbar_right
          = link_to (image_tag "/assets/lesson/edit.png", :alt => ''), "#", :onclick => "javascript: alert('editar aula');", :id => 'edit_lesson', :class => 'block_content_toolbar_button'
          = link_to (image_tag "/assets/lesson/delete.png", :alt => ''), "#", :onclick => "javascript: alert('excluir aula');", :id => 'delete_lesson', :class => 'block_content_toolbar_button'
          = link_to (image_tag "/assets/lesson/download.png", :alt => ''), "#", :onclick => "javascript: download_lesson_zip('#{m.id}');", :id => 'download_lesson', :class => 'block_content_toolbar_button'
          = link_to (image_tag "/assets/lesson/release_lessons.png", :alt => ''), "#", :onclick => "javascript: alert('libera aulas');", :id => 'release_lessons', :class => 'block_content_toolbar_button'

      %table.tb_list
        %thead
          %tr.lines
            %th{:style => 'text-align:center;'}
              = check_box_tag( 'all', 'all', false, {:id => "all_m_#{m.id}", :class => 'lesson_check_all'} )
            %th{:style => 'text-align:center;'}= t(".order")
            %th= t(".name")
            %th{:style => 'text-align:center;'}= t(".availability")
            %th{:style => 'text-align:center;'}= t(".acceptance")
        %tbody
          
          - unless lessons.nil? or lessons.empty?

            - lessons.each_with_index do |lesson, idxl|
              - css_class = (!lesson.description.nil? and !lesson.description.empty?) ? "lines remove_bottom_line" : "lines"

              %tr{:class => css_class}
                %td{:style => "width: 25px;", :align => 'center' }
                  = check_box_tag( "m_#{m.id}", lesson.id, false, {:class => "m_#{m.id}"} )
                %td{:style => "width: 50px;", :align => 'center'}
                  = link_to (image_tag "/assets/lesson/up_arrow.png", :alt => ''), "#", :onclick => "javascript: alert('sobe');", :id => 'up', :class => 'lesson_arrow' unless idxl == 0
                  = link_to (image_tag "/assets/lesson/down_arrow.png", :alt => ''), "#", :onclick => "javascript: alert('desce');", :id => 'down', :class => 'lesson_arrow' unless idxl == lessons.count-1
                %td 
                  = link_to lesson.name, "#", { :onclick => "javascript: alert('abre aula');", :id => "lesson#{lesson.id}", :class => 'link_content' }

                %td{:style => "width: 160px", :align => 'center'}
                  =t(".since") unless !lesson.schedule.end_date.nil?
                  =l lesson.schedule.start_date, :format => :normal
                  - unless lesson.schedule.end_date.nil?
                    =' - '
                    =l lesson.schedule.end_date, :format => :normal

                %td{:style => "width: 70px", :align => 'center'}
                  - if lesson.status == Lesson_Test
                    = link_to (image_tag "/assets/lesson/rejected_lesson.png", :alt => ''), "#", :onclick => "javascript: alert('rejeita aula');", :id => 'reject_lesson'
                  - else
                    = link_to (image_tag "/assets/lesson/released_lesson.png", :alt => ''), "#", :onclick => "javascript: alert('libera aula');", :id => 'release_lesson'

                  - if (!lesson.description.nil? and !lesson.description.empty?)
                    %tr.lines
                      %td{:style => "width: 25px;", :align => 'center' }
                      %td{:style => "width: 50px;", :align => 'center' }
                      %td{:colspan => 3, :class => 'lesson_description' }=lesson.description
          - else
            %tr.lines
              %td{:colspan => 3, :class => 'lesson_description' }
                =t(".none")

  - else
    .block_content.block_content_text 
      =t(".none")

  = button_to t(".new"), list_lessons_path(:allocation_tag_id => params[:allocation_tag_id]), :class => 'btn btn_default'

:javascript
  $(function() {

    $(".lesson_check_all").click(function() {
      var check  = this.checked;
      var module = this.id.slice(4);
      $("."+module).each(function(i) {
          $(this).attr("checked",check);
      });
    });

  });

  // função que retorna uma lista de ids das aulas selecionadas em determinado módulo
  function get_selected_lessons(module_id){
    lessons_ids = new Array;
    module_check_boxes = $('[name="m_'+module_id+'"]');
    // coloca, no array, todos os ids das aulas selecionadas para efetuar a ação do módulo
    module_check_boxes.map(function(){
      if(this.checked == true){ lessons_ids.push(this.value) }
    });
    return lessons_ids;
  }

  // verifica se pode realizar a ação (não permitirá e exibirá alerta se nenhuma aula tiver sido selecionada)
  function can_do_action(selected_lessons){
    if(selected_lessons.length == 0){
      alert('#{I18n.t(:must_select_lessons, :scope => [:lessons, :notifications])}');
      return false;
    }else{
      return true;
    }
  }


  // download dos arquivos das aulas selecionadas em um módulo
  function download_lesson_zip(module_id){
    allocation_tags_ids = $("#allocation_tag_id").val();
    lessons_ids         = get_selected_lessons(module_id);  

    if(can_do_action(lessons_ids)){
      window.location.href='#{download_files_lessons_path}?lessons_ids='+lessons_ids+'&allocation_tags_ids='+allocation_tags_ids;
    }
  }
