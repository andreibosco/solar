<div>
  <%= form_for('enrollments', url: enrollments_allocations_path, method: :get) do |f| %>
    <%= f.hidden_field(:offer_id, {:value => params[:offer_id], :name => :offer_id}) if params.include?(:offer_id) %>
    <%= f.hidden_field(:group_id, {:value => params[:group_id], :name => :group_id}) if params.include?(:group_id) %>
    <%= t(:status) %>:<%= select(:status, :id, status_hash.invert.to_a, {:prompt => t(:all), :selected => params[:status]},
    {:name => 'status', :onchange => "javascript:this.form.submit();"}) %>
  <% end %>
</div>

<div class="block_title">
  <h2><%= t(:allocation_manage_title) %></h2>
</div>
<div class="block_content">
  <table class="tb_list enrollments">
    <thead>
      <tr class="lines">
        <th>
          <input type="checkbox" name="all" value="all" id="cbx_all"/>
        </th>
        <th><%= t(:allocation_manage_student) %></th>
        <th><%= t(:allocation_manage_group) %></th>
        <th><%= t(:allocation_manage_status) %></th>
        <th><%= t(:allocation_manage_options) %></th>
      </tr>
    </thead>
    <tbody>
      <% @allocations.each do |allocation| %>
        <tr class="lines">
          <td>
            <input type="checkbox" name="<%= allocation.id %>" value="<%= allocation.id %>" class="cbx_value"/>
          </td>
          <td><%= allocation.user_name %></td>
          <td><%= allocation.group %></td>
          <td><%= name_of(allocation.status) %></td>
          <td>
            <input value="<%= t(:allocation_manage_manage) %>" show-link="<%= allocation_path(allocation) %>" edit-link="<%= edit_allocation_path(allocation) %>" type="button" class="btn btn_default btn_manage_enrollment" onclick="javascript:manage_enrollment(this);"/>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<script type="text/javascript">

  jQuery.fn.checkbox_all = function() {
    var args = $.extend({ 'cbx_id_all': 'cbx_all', 'cbx_class': 'cbx_value' }, arguments[0]);
    $('input:checkbox', this).click(function() {
      if ( $(this).attr("id") == args['cbx_id_all'] ) {
        var cbx_all = this;
        $('.' + args['cbx_class']).each(function() { $(this).attr('checked', $(cbx_all).attr('checked')); });
      } else if ( $(this).attr('checked') == false && $('#' + args['cbx_id_all']).attr('checked') == true ) {
        $('#' + args['cbx_id_all']).attr('checked', false);
      } else if ( $(this).attr('checked') == true && $('.' + args['cbx_class']).length == $('.' + args['cbx_class'] + ':checked').length ) {
        $('#' + args['cbx_id_all']).attr('checked', true);
      }
    });
  }

  $(".enrollments").checkbox_all();

  function manage_cancel(obj) {
    $.get($(obj).attr('show-link'), function(data) { $(obj).closest('tr').html(data); });
  }

  function manage_enrollment(obj) {
    $.get($(obj).attr('edit-link'), function(data) { $(obj).closest('tr').html(data); });
  }

  function save_allocation(obj) {
    $.ajax({
      type: 'PUT',
      url: $(obj).attr('save-link'),
      data: {"id": $(obj).attr('allocation-id'), "allocation": {
        "status": $('#status_id option:selected', $(obj).closest('tr')).val(), "group_id": $('#code_id option:selected', $(obj).closest('tr')).val()
      }},
      success: function(data) { $(obj).closest('tr').html(data); }
    });
  }
</script>
