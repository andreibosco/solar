jQuery(function(){

  /* Inicialização da árvore de arquivos */
  var selNodes;
  jQuery("#tree").dynatree({
    minExpandLevel: 2,
    checkbox: true,
    selectMode: 2, // alterado para o 2 para melhorar/facilitar a deleção de nós
    children: treeData,
    imagePath: "/assets/lesson/",
    onSelect: function(select, node) {
      node.visit(function(child){
        child.select(node.isSelected()); // seleciona ou de-seleciona nós filhos
      });
      selNodes = node.tree.getSelectedNodes();
    },
    onClick: function(node, event) {
      if ( node.getEventTargetType(event) == "title" )
        node.toggleSelect();
    },
    onDblClick: function(node, event) {
      editNode(node);
      return false;
    },
    onKeydown: function(node, event) {
      switch( event.which ) {
        case 113: // [F2]
          editNode(node);
          return false;
        case 32: // barra
          node.toggleSelect();
          return false;
        case 46: // [delete]
          deleteNodes([node]);
      }
    }
  });

  
  /* Inicialização da árvore de pastas para movimentação de arquivos e pastas */
  jQuery("#folders_tree").dynatree({
    minExpandLevel: 2,
    selectMode: 1,
    children: folderTreeData,
    imagePath: "/assets/lesson/",
    checkbox: true,
    classNames: {checkbox: "dynatree-radio"}, // Override class name for checkbox icon:
    onKeydown: function(node, event) {
      switch( event.which ) {
        case 27: // [F2]
          jQuery("#folder_window").hide();
        case 13: // enter
          node.select();
      }
    },
    onSelect: function(node, event) {
      node.activate();
    },
    onDblClick: function(node, event) {
      node.deactivate();
    }
  });

  /* Eventos de botões */
  
  /* Criar novo folder com texto padrao e foco para editar */
  jQuery("#btn-new-folder").click(function() { 
    var node              = jQuery("#tree").dynatree("getActiveNode");

    if (node != null && node.data.isFolder) {
      node_path = getPath(node);
      newFolder(node_path); // cria pasta no sistema
    }else
      flash_message("<%=I18n.t(:one_folder_must_be_selected, :scope => [:lesson_files])%>", "alert", "flash_messages");

    return false;
  });

  /* Selecionar ou deselecionar todos os itens */
  jQuery("#all_items_selector").click(function(){
    var value = jQuery("#all_items_selector").attr("checked") == "checked";
    jQuery("#tree").dynatree("getRoot").visit(function(node) {
      node.select(value);
    });
  });

  jQuery("#btn-remove-node").click(function(){
    activeNode = jQuery("#tree").dynatree("getActiveNode");
    if(typeof selNodes != "undefined")
      deleteNodes(selNodes); // deleta os nós que foram selecionados
    else if(activeNode != null)
        deleteNodes([activeNode]); // deleta o nó ativo
      else
        flash_message("<%= I18n.t(:at_least_one, :to => I18n.t(:remove, :scope => [:lesson_files]), :scope => [:lesson_files]) %>", "alert", "flash_messages");
  });

  jQuery("#btn-clean-lesson").click(function(){
    deleteNodes([jQuery("#tree").dynatree("getTree").getNodeByKey("_2")]); // deleta todos os nós
  });

  jQuery("#btn-rename").click(function(){
    var active_node = jQuery("#tree").dynatree("getActiveNode")
    if( active_node != null){
      editNode(active_node);
    }else if (typeof selNodes != "undefined" && selNodes.length == 1){
        editNode(selNodes[0]);
      }else
        flash_message("<%=I18n.t(:item_must_be_selected, :scope => [:lesson_files])%>", "alert", "flash_messages");
  });

  jQuery("#btn-move-node").click(function(){
    if(typeof selNodes == "undefined")
      flash_message("<%= I18n.t(:at_least_one, :to => I18n.t(:move, :scope => [:lesson_files]), :scope => [:lesson_files]) %>", "alert", "flash_messages");
    else
      jQuery("#folder_window").toggle();
  });

  jQuery("#btn-cancel-move").click(function(){
    jQuery("#folder_window").hide();
  });  

  jQuery("#btn-save-move").click(function(){
    saveMove(selNodes);
  });    

  jQuery("#btn-conclude").click(function(){
    removeLightBox();
  });

  jQuery("#btn-new-file").click(function(){
    var activeNode = jQuery("#tree").dynatree("getActiveNode");
    if (activeNode != null && activeNode.data.isFolder == true)
      jQuery("#fileupload").click();
    else
      flash_message("<%=I18n.t(:one_folder_must_be_selected, :scope => [:lesson_files])%>", "alert", "flash_messages");
  })

  jQuery(':file').change(function(){

    var activeNode = jQuery("#tree").dynatree("getActiveNode");

    for(var i=0; i < this.files.length; i++){ 
      file = this.files[i];
      extension = file.name.split(".");
      extension = extension[extension.length-1];
      if(jQuery.inArray(extension, extensions) != -1)
        var extension_error = true;
      else if(file.size > "<%=200.megabytes%>")
          var size_error = true
        else if(!validName(activeNode, file.name))
            var name_error = true
    }

    if(extension_error != true){
      if(size_error != true){
        if(name_error != true){

          var path     = getPath(activeNode);
          jQuery("#path").attr("value", path);
          var formData = new FormData(jQuery('#file_form')[0]);

          jQuery.ajax({
              url: jQuery("#file_form").attr("action"),  //server script to process data
              type: 'PUT',
              data: formData,
              //Options to tell JQuery not to process data or worry about content-type
              cache: false,
              contentType: false,
              processData: false,
              // xhr: function() {  // custom xhr
              //     myXhr = jQuery.ajaxSettings.xhr();
              //     if(myXhr.upload){ // check if upload property exists
              //         myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // for handling the progress of the upload
              //     }
              //     return myXhr;
              // },
              success: function(data){
                jQuery("#lesson_file_management").html(data);
              },
              error: function() {
                flash_message("<%=I18n.t(:upload_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
              }
          });

        }else
          flash_message("<%=I18n.t(:existing_file_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
      }else
        flash_message("<%=I18n.t(:file_too_big_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
    }else
      flash_message("<%=I18n.t(:bad_extension_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
  });

});

// function progressHandlingFunction(e){
//   if(e.lengthComputable){
//       jQuery('progress').attr({value:e.loaded,max:e.total});
//   }
// }

/* Retorna o caminho em que o nó se encontra */
function getPath(node){
  var path = []; 
  if(node.data.key != "_2") // se não for raiz
    path.unshift(node.data.title); 
  node.visitParents(function(node){ 
    if(node.parent && node.data.key != "_2")  // se não for raiz
      path.unshift(node.data.title); // cada novo título do nó é adicionado ao começo 
  }); 
  return "/" + path.join("/"); 
}

/* Verifica se o nome do nó é um nome válido */
function validName(parent_node, name){
  var unique_name = true;
  if(parent_node.childList != null){
    for(var i = 0; i <= parent_node.childList.length-1; i++){
      if(parent_node.getChildren()[i].data.title == name) // verifica se nome escolhido já existe
        unique_name = false;
    }

  }
  return unique_name;
}

/* Função para excluir nós selecionados ou todos */
function deleteNodes(nodes){
  if( typeof nodes != "undefined" ){
    if(nodes[0].data.key != "_2"){ // remover selecionados
      if (confirm("<%=I18n.t(:delete_confirm, :scope => [:lesson_files])%>")){
        for (var i = 0; i < nodes.length; i++){
          if (nodes[i].li != null && nodes[i].data.key != '_2')
            saveDeletion(nodes[i], false);
        }
      }else
        return false;
    }else{ // remover todos
      if (confirm("<%=I18n.t(:clean_lesson_confirm, :scope => [:lesson_files])%>"))
        saveDeletion(nodes[0], true);
      else
        return false;
    }
  }else
    flash_message("<%=I18n.t(:items_must_be_selected, :scope => [:lesson_files])%>", "alert", "flash_messages");
}

/* Renomear nó */
function editNode(node) {
  
  if (node.data.key == '_2') // raiz visivel
    return false;

  var prevTitle = node.data.title,
  tree = node.tree;
  tree.$widget.unbind(); // Disable dynatree mouse- and key handling
  jQuery(".dynatree-title", node.span).html("<input id='editNode' value='" + prevTitle + "'>"); // Replace node with <input>

  jQuery("input#editNode") // Focus <input> and bind keyboard handler
    .focus()
    .keydown(function(event) {
      switch( event.which ) {
        case 27: // [esc]
          jQuery("input#editNode").val(prevTitle); // discard changes on [esc]
          jQuery(this).blur();
          break;
        case 13: // [enter]

          var new_title = jQuery("input#editNode").val(); // Accept new value, when user leaves <input>
          node_path     = getPath(node); // recupera caminho do nó antes de mudar o título

          if(node.data.title != new_title){
            if(validName(node.parent, new_title) && new_title.length != 0){
              renameNode(node, new_title, node_path); // renomeia nó
              node.setTitle(new_title);
            }else{
              jQuery("input#editNode").val(node.data.title); // retorna ao antigo título
              flash_message("<%=I18n.t(:name_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
            }             
          }else
            erase_flash_messages();

          jQuery(this).blur(); // simulate blur to accept new value
          break;
      }
    }).blur(function(event){
      // Accept new value, when user leaves <input>
      var title = jQuery("input#editNode").val();
      node.setTitle(title); 
      // Re-enable mouse and keyboard handlling
      tree.$widget.bind();
      node.focus();
    });

}

/**** Métodos AJAX ****/

/* Salva a deleção de um nó */
function saveDeletion(node, root_node){
  url       = jQuery("#remove_path").attr("value"); // url para deleção
  node_path = getPath(node); // caminho do nó

  jQuery.ajax({
    type: 'DELETE',
    url: url,
    data: {
      "path": node_path,
      "root_node": root_node // informa se é a deleção do nó raiz, ou seja, de todos os arquivos da aula
    },
    success: function(data) {
      jQuery("#lesson_file_management").html(data);
    },
    error: function(data) {
      flash_message("<%=I18n.t(:delete_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
    }
  });
}

/* Cria pasta */
function newFolder(path){
  url = jQuery("#btn-new-folder").attr("value");

  jQuery.ajax({
    type: 'POST',
    url: url,
    data: {"path": path},
    success: function(data){
      jQuery("#lesson_file_management").html(data);
    },
    error: function() {
      // node.remove(); // remove pasta criada
      flash_message("<%=I18n.t(:new_folder_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
    }
  });
}

/* Renomeia nó */
function renameNode(node, new_title, path){
  url = jQuery("#rename_path").attr("value");

  jQuery.ajax({
    type: 'PUT',
    url: url,
    data: {
      "path": path,
      "node_name": new_title,
      "previous_name": node.data.title
    },
    success: function(data){
      jQuery("#lesson_file_management").html(data);
    },
    error: function() {
      node.setTitle(node.data.title); // retorna ao antigo título
      flash_message("<%=I18n.t(:rename_error, :scope => [:lesson_files])%>", "alert", "flash_messages");
    }
  }); 
}

/* Salvar a movimentação de pastas/arquivos */
/* Trechos comentados serão utilizados quando a movimentação for possível para drag'n'drop */
function saveMove(nodesToMove){

  var paths         = new Array;
  var nodesSelected = jQuery("#folders_tree").dynatree("getTree").getSelectedNodes();

  if (nodesSelected.length == 0)
    var error = true; // erro: nenhuma pasta destino selecionada
  else{
    var moveTo = getPath(nodesSelected[0]);  

    for(var i=0; i < nodesToMove.length; i++){ 
      
      // verifica se está movendo para a pasta atual e o nome da pasta a ser movida (se não estiver mudando de pasta, não verifica nome)
      if(nodesToMove[i].parent.data.key == nodesSelected[0].data.key || validName(nodesSelected[0], nodesToMove[i].data.title)){ 
        if( nodesToMove[i].data.key == nodesSelected[0].data.key ) 
          var same_folder = true; // erro: está movendo para ela mesma
        else{
          paths.push(getPath(nodesToMove[i])); // caminho do nó
          if(nodesToMove[i].countChildren() > 0) // verifica se é um nó pai selecionado
            i = i + nodesToMove[i].countChildren(); // pula filhos
        }
      }else{
        var invalid_name = true; // erro: já existe pasta de mesmo nome no destino
        i = nodesToMove.length; // concluir laço
      }

    }

  }

  if(error == true)
    flash_message("<%= I18n.t(:destination_folder_error, :scope => [:lesson_files]) %>", "alert", "flash_messages");
  else{
    if(invalid_name == true) 
      flash_message("<%= I18n.t(:existing_folder_error, :scope => [:lesson_files]) %>", "alert", "flash_messages");
    else{
      if(same_folder == true) 
        flash_message("<%= I18n.t(:same_folder_error, :scope => [:lesson_files]) %>", "alert", "flash_messages");
      else{
        jQuery.ajax({
          type: 'PUT',
          url: jQuery("#move_path").attr("value"),
          data: {
            "paths_to_move": paths,
            "path_to_move_to": moveTo
          },
          success: function(data) {
            jQuery("#lesson_file_management").html(data);
          },
          error: function() {
            flash_message("<%= I18n.t(:move_error, :scope => [:lesson_files]) %>", "alert", "flash_messages");
          }
        });
      }
    }
  }

}